{% extends 'base.html' %}

{% block body_class %}full-width-video-page{% endblock %}

{% block title %}Room {{ room_id }}{% endblock %}

{% block content %}
<section class="room-section">
    <div class="room-header">
        <h1>Welcome to Room {{ room_id }}</h1>
        <p class="muted">Team(s): {{ room_info.teams | join(', ') }}</p>
    </div>

    {% if room_info.youtube_stream_url %}
    <div class="video-container">
        <iframe width="1431" height="805" src="{{ room_info.youtube_stream_url }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
    {% endif %}

    <div id="modal-container" class="modal-backdrop">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button id="modal-dismiss-btn" class="btn btn-primary">Dismiss</button>
        </div>
    </div>

    <div id="toast-container"></div>
</section>

<script>
    const ROOM_ID = "{{ room_id }}";
    const TEAMS_IN_ROOM = {{ room_info.teams | tojson | safe }};
    let popupTimeout;
    let currentModalPopupId = null;
    const activeToastIds = new Set();

    function showModalPopup(message, duration = 10, popupId) {
        console.log(`Showing modal: id=${popupId}, message=${message}, duration=${duration}`);
        const modal = document.getElementById('modal-container');
        const messageEl = document.getElementById('modal-message');
        const dismissBtn = document.getElementById('modal-dismiss-btn');

        currentModalPopupId = popupId;

        if (popupTimeout) {
            clearTimeout(popupTimeout);
        }

        messageEl.innerText = message;
        modal.style.display = 'flex';

        const hideModal = () => {
            modal.style.display = 'none';
            if (popupTimeout) {
                clearTimeout(popupTimeout);
            }
            if (currentModalPopupId) {
                console.log(`Dismissing modal via UI: id=${currentModalPopupId}`);
                dismissPopup(currentModalPopupId);
                currentModalPopupId = null;
            }
        };

        dismissBtn.onclick = hideModal;

        popupTimeout = setTimeout(hideModal, duration * 1000);
    }

    function showToastPopup(message, duration = 10, popupId, title = "Notification") {
        console.log(`Showing toast: id=${popupId}, title=${title}, message=${message}, duration=${duration}`);
        if (activeToastIds.has(popupId)) {
            console.log(`Toast ${popupId} is already active.`);
            return;
        }

        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.id = `toast-${popupId}`;

        // Add a title and body for better structure
        toast.innerHTML = `
            <div class="toast-title">${title}</div>
            <div class="toast-body">${message}</div>
        `;

        activeToastIds.add(popupId);
        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        // Set timer to remove the toast
        setTimeout(() => {
            toast.classList.remove('show');
            // Remove from DOM after transition
            toast.addEventListener('transitionend', () => {
                toast.remove();
                activeToastIds.delete(popupId);
                // Also inform the backend it's gone
                dismissPopup(popupId);
            });
        }, duration * 1000);
    }

    async function dismissPopup(popupId) {
        console.log(`Sending dismiss request to server for popup_id: ${popupId}`);
        try {
            const response = await fetch('/api/popups/dismiss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ popup_id: popupId }),
            });
            if (response.ok) {
                console.log(`Successfully dismissed popup_id: ${popupId}`);
            } else {
                console.error(`Failed to dismiss popup_id: ${popupId}`, await response.json());
            }
        } catch (error) {
            console.error('Failed to send dismiss request:', error);
        }
    }

    async function checkManualPopups() {
        console.log("Checking for popups...");
        const response = await fetch('/api/popups');
        const popups = await response.json();
        
        const popupsForThisRoom = popups.filter(p => p && p.room_ids && p.room_ids.includes(ROOM_ID));
        
        // Handle Modals
        const modalPopup = popupsForThisRoom.find(p => (p.type || 'modal') === 'modal');
        if (modalPopup) {
            if (modalPopup.id !== currentModalPopupId) {
                console.log(`New modal found (current: ${currentModalPopupId}, new: ${modalPopup.id}). Showing it.`);
                showModalPopup(modalPopup.message, modalPopup.duration, modalPopup.id);
            }
        } else {
            // If no modal is active for this room, ensure it's hidden
            const modal = document.getElementById('modal-container');
            if (modal.style.display !== 'none' && currentModalPopupId) {
                 modal.style.display = 'none';
                 currentModalPopupId = null;
            }
        }

        // Handle Toasts
        const toastPopups = popupsForThisRoom.filter(p => p.type === 'toast');
        toastPopups.forEach(toastPopup => {
            if (!activeToastIds.has(toastPopup.id)) {
                showToastPopup(toastPopup.message, toastPopup.duration, toastPopup.id, toastPopup.title);
            }
        });
    }

    setInterval(checkManualPopups, 3000); // Check more frequently
</script>

<style>
    .full-width-video-page header {
        display: none;
    }
    .full-width-video-page main {
        max-width: none;
        margin: 0;
        padding: 0;
    }
    .room-section {
        width: 100%;
    }
    .room-header {
        padding: 0 1rem;
        margin-bottom: 1rem;
        position: absolute;
        top: 1rem;
        left: 1rem;
        z-index: 10;
        background: rgba(0,0,0,0.5);
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }
    .room-header h1, .room-header p {
        color: white;
        text-shadow: 1px 1px 2px black;
    }
    .video-container {
        position: relative;
        width: 100vw;
        height: 100vh;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .modal-backdrop {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: var(--color-background);
        color: var(--color-text);
        padding: 2rem 3rem;
        border-radius: 8px;
        text-align: center;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content p {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
    }

    #toast-container {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 350px;
    }
    .toast {
        background-color: #2c3e50; /* Darker, more solid background */
        color: #ecf0f1; /* Lighter text for contrast */
        padding: 1.25rem 1.75rem; /* Increased padding */
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4); /* More pronounced shadow */
        opacity: 0;
        transform: translateX(-120%);
        transition: opacity 0.5s ease, transform 0.5s ease;
        border-left: 7px solid #3498db; /* Thicker, brighter accent border */
        min-width: 320px;
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    .toast-title {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }
    .toast-body {
        font-size: 1rem;
    }
</style>
{% endblock %}
