{% extends 'base.html' %}

{% block title %}Manual Controls{% endblock %}

{% block content %}
<section>
    <h1>Manual Controls</h1>
    <p class="muted">A dashboard for direct control over event systems.</p>
    
    <div class="quad-grid">
        <!-- Lighting Control Panel -->
        <div class="control-card">
            <h2>
                <i class="ri-lightbulb-line"></i> Lighting
                <button id="edit-lighting-btn" class="icon-btn" onclick="toggleLightingEditMode()"><i class="ri-pencil-line"></i></button>
            </h2>
            <div class="preset-grid" id="lighting-preset-grid">
                <!-- Presets will be dynamically inserted here -->
            </div>
            <div class="manual-entry">
                <select id="lighting-target-type">
                    <option value="cue" selected>Cue</option>
                    <option value="playback">Playback</option>
                </select>
                <input type="number" id="lighting-target-id" placeholder="ID">
                <select id="lighting-command">
                    <option value="release" selected>Release</option>
                    <option value="go">Go</option>
                    <option value="pause">Pause</option>
                    <option value="next">Next</option>
                </select>
                <button onclick="sendManualLighting()">Send</button>
            </div>
            <div id="lighting-edit-panel" style="display: none;">
                <h3>Edit Presets</h3>
                <div class="manual-entry">
                    <input type="text" id="new-preset-name" placeholder="Preset Name">
                    <input type="number" id="new-preset-id" placeholder="Preset ID">
                    <button id="add-preset-btn">Add</button>
                </div>
                <p class="muted">In edit mode, click a preset to remove it. Click the edit icon again to save.</p>
            </div>
        </div>

        <!-- Audio Control Panel -->
        <div class="control-card">
            <h2><i class="ri-spotify-line"></i> Audio</h2>
            <div class="quick-actions">
                <button onclick="triggerAction('audio', { command: 'play' })"><i class="ri-play-line"></i> Play</button>
                <button onclick="triggerAction('audio', { command: 'pause' })"><i class="ri-pause-line"></i> Pause</button>
                <button onclick="triggerAction('audio', { command: 'next_track' })"><i class="ri-skip-forward-line"></i> Skip</button>
                <button onclick="triggerAction('audio', { command: 'previous_track' })"><i class="ri-rewind-line"></i> Restart</button>
            </div>
            <div class="manual-entry">
                <input type="text" id="audio-command" placeholder="Manual command">
                <input type="text" id="audio-context" placeholder="Context URI (optional)">
                <button onclick="sendManualAudio()">Send</button>
            </div>
        </div>

        <!-- Camera Control Panel -->
        <div class="control-card">
            <h2><i class="ri-camera-line"></i> Camera</h2>
            <div class="quick-actions">
                <button onclick="triggerAction('video', { command: 'change_program_input', camera_id: 1 })">Cam 1</button>
                <button onclick="triggerAction('video', { command: 'change_program_input', camera_id: 2 })">Cam 2</button>
                <button onclick="triggerAction('video', { command: 'change_program_input', camera_id: 3 })">Cam 3</button>
            </div>
        </div>

        <!-- Popup Control Panel -->
        <div class="control-card" id="popups-card">
            <h2><i class="ri-message-2-line"></i> Popups</h2>
            <div class="manual-entry">
                <input type="text" id="popup-message" placeholder="Popup Message">
                <div class="room-selection">
                    <p>Send to rooms:</p>
                    <!-- Room checkboxes will be dynamically inserted here -->
                </div>
                <button onclick="sendPopup()">Send Popup</button>
            </div>
            <div class="active-popups">
                <h3>Active Popups</h3>
                <ul id="popup-list">
                    <!-- Active popups will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <hr>

    <section class="control-section">
        <h2>System Reset</h2>
        <p class="muted">This will clear the current match schedule, remove all pending notifications, and reset any notified match history. This is useful at the start of a new event or if the schedule has become corrupted.</p>
        <form id="reset-system-form" method="POST" action="/api/system/reset">
            <button type="submit" class="btn btn-danger">Reset System</button>
        </form>
    </section>

</main>

<script>
    // --- Generic Action Trigger ---
    async function triggerAction(type, params) {
        const payload = { type, ...params };
        console.log('Triggering action:', payload);
        try {
            const response = await fetch('/api/trigger_action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                console.error('Failed to trigger action:', await response.text());
            }
        } catch (error) {
            console.error('Error sending action:', error);
        }
    }

    // --- Specific Handlers for Manual Inputs ---
    function sendManualLighting() {
        const targetId = document.getElementById('lighting-target-id').value;
        const targetType = document.getElementById('lighting-target-type').value;
        const command = document.getElementById('lighting-command').value;

        let idToSend = null;
        if (targetType === 'cue') {
            // If cue and empty, default to 1
            if (!targetId || targetId.toString().trim() === '') {
                idToSend = 1;
            } else {
                idToSend = parseInt(targetId);
            }
        } else {
            // For playback, require an ID
            if (!targetId || targetId.toString().trim() === '') {
                alert('Please provide an ID for the selected target type.');
                return;
            }
            idToSend = parseInt(targetId);
        }

        triggerAction('lighting', { 
            preset_id: idToSend,
            target_type: targetType,
            command: command
        });
    }

    function sendManualAudio() {
        const command = document.getElementById('audio-command').value;
        const contextUri = document.getElementById('audio-context').value;
        if (command) {
            let payload = { command };
            if (contextUri) {
                payload.metadata = { context_uri: contextUri };
            }
            triggerAction('audio', payload);
        }
    }

    // --- Popup Management ---
    async function sendPopup() {
        const message = document.getElementById('popup-message').value;
        if (!message) return;

        const selectedRooms = Array.from(document.querySelectorAll('.room-selection input:checked'))
                                   .map(cb => cb.value);
        
        if (selectedRooms.length === 0) {
            alert("Please select at least one room.");
            return;
        }

        const payload = {
            message: message,
            room_ids: selectedRooms,
            duration: 15 // seconds, or make this configurable
        };

        await fetch('/api/send_popup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        // After sending, refresh the list of active popups
        setTimeout(fetchActivePopups, 500);
    }

    async function removePopup(popupId) {
        await fetch(`/api/remove_popup/${popupId}`, { method: 'POST' });
        setTimeout(fetchActivePopups, 500);
    }

    async function fetchActivePopups() {
        try {
            const response = await fetch('/api/active_popups');
            const data = await response.json();
            const popups = Array.isArray(data) ? data : []; // Ensure popups is an array
            const popupList = document.getElementById('popup-list');
            popupList.innerHTML = ''; // Clear current list
            if (popups.length === 0) {
                popupList.innerHTML = '<li>No active popups.</li>';
            } else {
                popups.forEach(popup => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${popup.message} <i>(Rooms: ${popup.room_ids.join(', ')})</i></span>
                        <button class="remove-btn" onclick="removePopup('${popup.id}')">&times;</button>
                    `;
                    popupList.appendChild(li);
                });
            }
        } catch (error) {
            console.error("Failed to fetch active popups:", error);
            document.getElementById('popup-list').innerHTML = '<li>Error loading popups.</li>';
        }
    }
    
    async function fetchRooms() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            const rooms = config.rooms || {};
            const roomSelectionDiv = document.querySelector('.room-selection');
            
            // Clear existing checkboxes
            const p = roomSelectionDiv.querySelector('p');
            roomSelectionDiv.innerHTML = '';
            roomSelectionDiv.appendChild(p);

            if (Object.keys(rooms).length > 0) {
                for (const roomId in rooms) {
                    const label = document.createElement('label');
                    label.className = 'checkbox-label';
                    label.innerHTML = `<input type="checkbox" value="${roomId}"> <span>${roomId}</span>`;
                    roomSelectionDiv.appendChild(label);
                }
            } else {
                roomSelectionDiv.innerHTML += '<p class="muted">No rooms configured.</p>';
            }
        } catch (error) {
            console.error("Failed to fetch rooms:", error);
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchRooms();
        fetchActivePopups();
        fetchLightingPresets();
        // Refresh popups every 10 seconds
        setInterval(fetchActivePopups, 10000);
    });

    // --- Lighting Controls ---
    let lightingPresets = [];
    let lightingEditMode = false;

    async function fetchLightingPresets() {
        try {
            const response = await fetch('/api/presets');
            const data = await response.json();
            lightingPresets = data.lighting || [];
            renderLightingPresets();
        } catch (error) {
            console.error("Failed to fetch lighting presets:", error);
        }
    }

    function renderLightingPresets() {
        const grid = document.getElementById('lighting-preset-grid');
        grid.innerHTML = '';
        lightingPresets.forEach((preset, index) => {
            const btn = document.createElement('button');
            btn.className = 'preset-btn';
            btn.textContent = preset.name;
            btn.title = `ID: ${preset.preset_id}`;
            btn.onclick = () => handlePresetClick(index);
            grid.appendChild(btn);
        });
    }

    function handlePresetClick(index) {
        if (lightingEditMode) {
            // Remove preset
            lightingPresets.splice(index, 1);
            renderLightingPresets();
            updateEditModeUI();
        } else {
            // Trigger action
            const preset = lightingPresets[index];
            triggerAction('lighting', { preset_id: preset.preset_id });
        }
    }

    function toggleLightingEditMode() {
        lightingEditMode = !lightingEditMode;
        if (!lightingEditMode) {
            // Save changes
            saveLightingPresets();
        }
        updateEditModeUI();
    }

    function updateEditModeUI() {
        const editPanel = document.getElementById('lighting-edit-panel');
        const grid = document.getElementById('lighting-preset-grid');
        const editBtnIcon = document.querySelector('#edit-lighting-btn i');

        editPanel.style.display = lightingEditMode ? 'block' : 'none';
        if (lightingEditMode) {
            grid.classList.add('edit-mode');
            editBtnIcon.classList.remove('ri-pencil-line');
            editBtnIcon.classList.add('ri-save-line');
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.add('remove-mode'));
        } else {
            grid.classList.remove('edit-mode');
            editBtnIcon.classList.remove('ri-save-line');
            editBtnIcon.classList.add('ri-pencil-line');
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('remove-mode'));
        }
    }

    document.getElementById('add-preset-btn').addEventListener('click', () => {
        const nameInput = document.getElementById('new-preset-name');
        const idInput = document.getElementById('new-preset-id');
        const name = nameInput.value.trim();
        const presetId = parseInt(idInput.value.trim());

        if (name && !isNaN(presetId)) {
            lightingPresets.push({ name: name, preset_id: presetId });
            renderLightingPresets();
            updateEditModeUI();
            nameInput.value = '';
            idInput.value = '';
        } else {
            alert('Please provide a valid name and ID for the preset.');
        }
    });

    async function saveLightingPresets() {
        try {
            await fetch('/api/presets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lighting: lightingPresets })
            });
        } catch (error) {
            console.error('Failed to save lighting presets:', error);
            alert('Failed to save presets. Check console for details.');
        }
    }

    document.getElementById('reset-system-form').addEventListener('submit', function(event) {
        event.preventDefault();
        if (confirm('Are you sure you want to reset the system? This will clear the schedule and all notifications.')) {
            fetch('/api/system/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    alert('System has been reset successfully.');
                    location.reload();
                } else {
                    alert('Failed to reset the system.');
                }
            }).catch(error => {
                console.error('Error resetting system:', error);
                alert('An error occurred while resetting the system.');
            });
        }
    });
</script>

<style>
    .quad-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .control-card {
        background-color: var(--color-background-secondary);
        padding: 1.5rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .control-card h2 {
        margin-top: 0;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .control-card h2 .icon-btn {
        background: none;
        border: none;
        color: var(--color-text-muted);
        font-size: 0.8em;
        cursor: pointer;
        margin-left: auto;
    }

    .preset-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
    }

    .preset-btn {
        aspect-ratio: 1 / 1;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .preset-btn.remove-mode:hover {
        background-color: var(--color-danger);
        color: white;
    }

    .manual-entry {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .manual-entry input {
        flex-grow: 1;
        width: auto;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    
    .quick-actions button {
        padding: 0.8rem;
    }

    #popups-card .manual-entry {
        flex-direction: column;
    }
    
    .room-selection {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 0.5rem 0;
    }
    
    .room-selection p {
        margin: 0;
        font-weight: bold;
    }
    
    .room-selection label {
        display: block;
        background: var(--color-background-primary);
        padding: 0.5rem;
        border-radius: 4px;
    }

    .active-popups {
        margin-top: 1rem;
        border-top: 1px solid var(--color-border);
        padding-top: 1rem;
    }
    
    .active-popups h3 {
        margin-top: 0;
    }

    #popup-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    #popup-list li {
        background-color: var(--color-background-primary);
        padding: 0.5rem 1rem;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #popup-list li i {
        font-size: 0.9em;
        color: var(--color-text-muted);
    }

    .remove-btn {
        background: none;
        border: none;
        color: var(--color-accent);
        font-size: 1.5em;
        line-height: 1;
        cursor: pointer;
        padding: 0 0.5rem;
    }

    .control-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--color-background-secondary);
        border-radius: 8px;
    }

    .control-section h2 {
        margin-top: 0;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 0.5rem;
    }

    .btn-danger {
        background-color: var(--color-danger);
        color: white;
        border: none;
        padding: 0.8rem 1.2rem;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        display: inline-block;
        text-align: center;
    }

    .btn-danger:hover {
        background-color: var(--color-danger-dark);
    }
</style>
{% endblock %}
