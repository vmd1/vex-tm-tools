{% extends "base.html" %}

{% block title %}Server Logs{% endblock %}

{% block content %}
<style>
  #log-container {
    background-color: #0b1226;
    color: #cbd6f5;
    font-family: 'SF Mono', 'Fira Code', 'Source Code Pro', monospace;
    font-size: 0.85rem;
    padding: 1rem;
    border-radius: 8px;
    height: 70vh;
    overflow-y: auto;
    border: 1px solid var(--surface);
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .log-line {
    display: flex;
  }
  .log-meta {
    color: var(--muted);
    margin-right: 1rem;
    flex-shrink: 0;
  }
  .log-message {
    flex-grow: 1;
  }
  .log-line[data-level="INFO"] .log-message { color: #7aa2f7; }
  .log-line[data-level="WARNING"] .log-message { color: #ff9e64; }
  .log-line[data-level="ERROR"] .log-message { color: #f7768e; }
  .log-line[data-level="CRITICAL"] .log-message { color: #f7768e; font-weight: bold; }
  .log-line[data-level="DEBUG"] .log-message { color: #9d7cd8; }

  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    background: rgba(255,255,255,0.02);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.03);
  }
</style>

<div class="controls-bar">
  <h2><i class="ri-file-list-3-line"></i> Server Logs</h2>
  <div class="but-row">
    <label class="checkbox-label">
      <input type="checkbox" id="autoscroll-toggle" checked>
      <span>Autoscroll</span>
    </label>
    <button id="clear-logs-btn" class="btn btn-secondary"><i class="ri-delete-bin-line"></i> Clear</button>
  </div>
</div>

<div id="log-container">
  <div id="log-content"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const logContent = document.getElementById('log-content');
    const logContainer = document.getElementById('log-container');
    const autoscrollToggle = document.getElementById('autoscroll-toggle');
    const clearLogsBtn = document.getElementById('clear-logs-btn');
    let eventSource;

    function connect() {
      // Close existing connection if any
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource("{{ url_for('stream_logs') }}");

      eventSource.onmessage = function(event) {
        const line = event.data;
        const logLineEl = document.createElement('div');
        logLineEl.className = 'log-line';

        // Simple parsing to add color based on log level
        const parts = line.split(' - ');
        if (parts.length >= 4) {
            const timestamp = parts[0];
            const loggerName = parts[1];
            const level = parts[2];
            const message = parts.slice(3).join(' - ');
            
            logLineEl.dataset.level = level;
            logLineEl.innerHTML = `<span class="log-meta">${timestamp} [${level}]</span><span class="log-message">${message}</span>`;
        } else {
            logLineEl.innerHTML = `<span class="log-message">${line}</span>`;
        }
        
        logContent.appendChild(logLineEl);

        if (autoscrollToggle.checked) {
          logContainer.scrollTop = logContainer.scrollHeight;
        }
      };

      eventSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        const errorLine = document.createElement('div');
        errorLine.className = 'log-line';
        errorLine.dataset.level = 'ERROR';
        errorLine.innerHTML = `<span class="log-message">--- Connection to log stream lost. Reconnecting... ---</span>`;
        logContent.appendChild(errorLine);
        eventSource.close();
        // Attempt to reconnect after a delay
        setTimeout(connect, 5000);
      };
    }

    clearLogsBtn.addEventListener('click', () => {
      logContent.innerHTML = '';
    });

    connect(); // Initial connection
  });
</script>
{% endblock %}
